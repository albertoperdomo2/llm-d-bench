name: llm-d-bench via PR Comment

# Trigger benchmarks with PR comments
#
# Usage:
#   /benchmark <experiment-name>
#
# With parameter overrides:
#   /benchmark <experiment-name>
#   pvc.create=true
#   benchmark.maxSeconds=600
#   kueue.enabled=false
#
# Parameters use dot notation and override values from the experiment file.
# Supports all Helm value types: strings, numbers, booleans, and comma-separated lists.

on:
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write

jobs:
  benchmark:
    if: |
      github.event.issue.pull_request &&
      startsWith(github.event.comment.body, '/benchmark') &&
      github.actor == github.repository_owner

    environment: benchmark
    runs-on: [self-hosted, openshift]

    steps:
      - name: React to comment
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'eyes'
            });

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ github.event.issue.number }}/head
          repository: ${{ github.event.repository.full_name }}

      - name: Parse experiment name and overrides
        id: parse
        run: |
          COMMENT_BODY="${{ github.event.comment.body }}"

          EXPERIMENT=$(echo "$COMMENT_BODY" | head -1 | sed -n 's|^/benchmark \([^ ]*\).*|\1|p' | tr -d '\n\r')

          if [ -z "$EXPERIMENT" ]; then
            echo "error=No experiment specified" >> $GITHUB_OUTPUT
            exit 1
          fi

          if ! echo "$EXPERIMENT" | grep -Eq '^[a-zA-Z0-9_-]+$'; then
            echo "error=Invalid experiment name. Only alphanumeric, -, and _ are allowed." >> $GITHUB_OUTPUT
            exit 1
          fi

          EXPERIMENT_FILE="llm-d-bench/experiments/${EXPERIMENT}.yaml"

          if [ ! -f "$EXPERIMENT_FILE" ]; then
            echo "error=Experiment file not found: $EXPERIMENT_FILE" >> $GITHUB_OUTPUT
            echo "experiment=$EXPERIMENT" >> $GITHUB_OUTPUT
            exit 1
          fi

          # Parse override parameters from subsequent lines
          # format: key.path=value
          SET_ARGS=""
          OVERRIDES_SUMMARY=""

          while IFS= read -r line; do
            if [[ -z "$line" ]] || [[ "$line" =~ ^/benchmark ]]; then
              continue
            fi

            if [[ "$line" =~ ^[a-zA-Z0-9_.]+=[^[:space:]]+$ ]]; then
              KEY=$(echo "$line" | cut -d= -f1 | tr -d '\n\r')
              VALUE=$(echo "$line" | cut -d= -f2- | tr -d '\n\r')

              if ! echo "$KEY" | grep -Eq '^[a-zA-Z0-9_.]+$'; then
                echo "error=Invalid override key: $KEY" >> $GITHUB_OUTPUT
                exit 1
              fi

              SET_ARGS="$SET_ARGS --set $KEY=$VALUE"
              OVERRIDES_SUMMARY="${OVERRIDES_SUMMARY}- \`$KEY=$VALUE\`\n"
            fi
          done <<< "$COMMENT_BODY"

          echo "experiment=$EXPERIMENT" >> $GITHUB_OUTPUT
          echo "experiment_file=$EXPERIMENT_FILE" >> $GITHUB_OUTPUT
          echo "set_args=$SET_ARGS" >> $GITHUB_OUTPUT

          if [ -n "$OVERRIDES_SUMMARY" ]; then
            echo "overrides_summary<<EOF" >> $GITHUB_OUTPUT
            echo -e "$OVERRIDES_SUMMARY" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "overrides_summary=" >> $GITHUB_OUTPUT
          fi

          echo "Experiment file: $EXPERIMENT_FILE"
          if [ -n "$SET_ARGS" ]; then
            echo "Override arguments: $SET_ARGS"
          fi

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.14.0'

      - name: Install OpenShift CLI
        uses: redhat-actions/openshift-tools-installer@v1
        with:
          oc: 'latest'

      - name: Log in to OpenShift
        env:
          OPENSHIFT_SERVER_URL: ${{ secrets.OPENSHIFT_SERVER_URL }}
          OPENSHIFT_CA_CERT: ${{ secrets.OPENSHIFT_CA_CERT }}
          OPENSHIFT_TOKEN: ${{ secrets.OPENSHIFT_TOKEN }}
        run: |
          echo "$OPENSHIFT_CA_CERT" > ca.crt
          oc login $OPENSHIFT_SERVER_URL --token=$OPENSHIFT_TOKEN --certificate-authority=ca.crt
          oc config set-context --current --namespace=llm-d-inference-scheduling

      - name: Execute benchmark job
        id: execute
        run: |
          RELEASE_NAME="benchmark-pr-${{ github.event.issue.number }}-$(date +%s)"
          echo "release_name=$RELEASE_NAME" >> $GITHUB_OUTPUT

          echo "## Benchmark Execution" >> $GITHUB_STEP_SUMMARY
          echo "**Experiment:** \`${{ steps.parse.outputs.experiment }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -n "${{ steps.parse.outputs.overrides_summary }}" ]; then
            echo "**Parameter Overrides:**" >> $GITHUB_STEP_SUMMARY
            echo "${{ steps.parse.outputs.overrides_summary }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          echo "**Release Name:** \`$RELEASE_NAME\`" >> $GITHUB_STEP_SUMMARY

          helm install "$RELEASE_NAME" ./llm-d-bench \
            -f "${{ steps.parse.outputs.experiment_file }}" \
            --set benchmark.name="$RELEASE_NAME" \
            ${{ steps.parse.outputs.set_args }} \
            -n llm-d-inference-scheduling

      - name: Wait for job completion
        id: results
        run: |
          JOB_NAME="${{ steps.execute.outputs.release_name }}"
          echo "Job name: $JOB_NAME"

          oc wait --for=condition=complete --timeout=120m \
            -n llm-d-inference-scheduling job/$JOB_NAME || true

      - name: Cleanup on failure
        if: failure()
        run: |
          helm uninstall "${{ steps.execute.outputs.release_name }}" \
            -n llm-d-inference-scheduling || true

      - name: Update reaction on completion
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const reaction = '${{ job.status }}' === 'success' ? 'rocket' : 'confused';
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: reaction
            });
