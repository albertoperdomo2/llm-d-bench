name: llm-d-bench via PR Comment

on:
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write
  id-token: write

jobs:
  benchmark:
    if: |
      github.event.issue.pull_request &&
      startsWith(github.event.comment.body, '/benchmark') &&
      github.actor == github.repository_owner

    environment: benchmark
    runs-on: ubuntu-latest

    steps:
      - name: React to comment
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'eyes'
            });

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ github.event.issue.number }}/head
          repository: ${{ github.event.repository.full_name }}

      - name: Parse experiment name
        id: parse
        run: |
          COMMENT_BODY="${{ github.event.comment.body }}"
          EXPERIMENT=$(echo "$COMMENT_BODY" | sed -n 's|^/benchmark \([^ ]*\).*|\1|p' | tr -d '\n\r')

          if [ -z "$EXPERIMENT" ]; then
            echo "error=No experiment specified" >> $GITHUB_OUTPUT
            exit 1
          fi

          if ! echo "$EXPERIMENT" | grep -Eq '^[a-zA-Z0-9_-]+$'; then
            echo "error=Invalid experiment name. Only alphanumeric, -, and _ are allowed." >> $GITHUB_OUTPUT
            exit 1
          fi

          EXPERIMENT_FILE="llm-d-bench/experiments/${EXPERIMENT}.yaml"

          if [ ! -f "$EXPERIMENT_FILE" ]; then
            echo "error=Experiment file not found: $EXPERIMENT_FILE" >> $GITHUB_OUTPUT
            echo "experiment=$EXPERIMENT" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "experiment=$EXPERIMENT" >> $GITHUB_OUTPUT
          echo "experiment_file=$EXPERIMENT_FILE" >> $GITHUB_OUTPUT
          echo "Experiment file: $EXPERIMENT_FILE"

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.14.0'

      - name: Install OpenShift CLI
        uses: redhat-actions/openshift-tools-installer@v1
        with:
          oc: 'latest'

      - name: Get GitHub OIDC Token
        id: get_token
        env:
          AUDIENCE: "openshift"
        run: |
          TOKEN=$(curl -s -H "Authorization: Bearer ${ACTIONS_ID_TOKEN_REQUEST_TOKEN}" \
            "${ACTIONS_ID_TOKEN_REQUEST_URL}&audience=${AUDIENCE}" | jq -r .value)

          echo "::add-mask::$TOKEN"
          echo "token=$TOKEN" >> $GITHUB_OUTPUT

          # debug
          echo "Token generated. Length: ${#TOKEN}"
          echo "Decoding token claims..."
          PAYLOAD=$(echo $TOKEN | cut -d'.' -f2 | base64 -d)
          echo "CLAIMS: $PAYLOAD"

          echo "---"
          echo "Issuer (iss): $(echo $PAYLOAD | jq -r .iss)"
          echo "Audience (aud): $(echo $PAYLOAD | jq -r .aud)"
          echo "Subject (sub): $(echo $PAYLOAD | jq -r .sub)"
          echo "---"

      - name: Log in to OpenShift
        env:
          OPENSHIFT_SERVER_URL: ${{ secrets.OPENSHIFT_SERVER_URL }}
          OPENSHIFT_CA_CERT: ${{ secrets.OPENSHIFT_CA_CERT }}
          OIDC_TOKEN: ${{ steps.get_token.outputs.token }}
        run: |
          echo "$OPENSHIFT_CA_CERT" > ca.crt
          oc login $OPENSHIFT_SERVER_URL --token=$OIDC_TOKEN --certificate-authority=ca.crt
          oc config set-context --current --namespace=llm-d-inference-scheduling

      - name: Deploy benchmark job
        id: deploy
        run: |
          RELEASE_NAME="benchmark-pr-${{ github.event.issue.number }}-$(date +%s)"
          echo "release_name=$RELEASE_NAME" >> $GITHUB_OUTPUT

          echo "Starting benchmark with experiment: ${{ steps.parse.outputs.experiment }}" >> $GITHUB_STEP_SUMMARY

          helm install "$RELEASE_NAME" ./llm-d-bench \
            -f "${{ steps.parse.outputs.experiment_file }}" \
            --set pvc.create=true -n llm-d-inference-scheduling

      - name: Wait for job completion
        id: results
        run: |
          JOB_NAME="${{ steps.deploy.release_name }}"
          echo "Job name: $JOB_NAME"

          oc wait --for=condition=complete --timeout=60m \
            -n llm-d-inference-scheduling job/$JOB_NAME || true

      - name: Cleanup on failure
        if: failure()
        run: |
          helm uninstall "${{ steps.deploy.outputs.release_name }}" \
            -n llm-d-inference-scheduling || true

      - name: Update reaction on completion
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const reaction = '${{ job.status }}' === 'success' ? 'rocket' : 'confused';
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: reaction
            });
